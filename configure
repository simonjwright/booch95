#! /bin/sh

# Copyright (C) Simon Wright <simon@pushface.org>.

# This package is free software; you can redistribute it and/or
# modify it under terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2, or
# (at your option) any later version. This package is distributed in
# the hope that it will be useful, but WITHOUT ANY WARRANTY; without
# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE. See the GNU General Public License for more
# details. You should have received a copy of the GNU General Public
# License distributed with this package; see file COPYING.  If not,
# write to the Free Software Foundation, 59 Temple Place - Suite
# 330, Boston, MA 02111-1307, USA.

# Determine the prefix of the GNAT system to which the current
# 'gnatmake' belongs and use it to edit Makefile.in and create a
# Makefile that will install the BCs in that system.

# project_dir is the shortest of the 'Project Search Path' entries in
# the output of 'gnatls -v' that ends 'lib/gnat' (Windows backslashes
# changed to slashes, eg 'C:/GNAT/2011/lib/gnat')
project_dir=`gnatls -v | awk '
/Project Search Path/ {started = 1}
!started {next}
{gsub(/\\\\/, "/")}
/adainclude/ {path = $0}
/lib\/gnat/ {
    if (!path || length(path) > length($0)) {
	path = $0
    }
}
END {print path}
'`

prefix=`(cd $project_dir/../..; echo $PWD)`

sed \
    -e "s;@PREFIX@;$prefix;" \
    <Makefile.in >Makefile
